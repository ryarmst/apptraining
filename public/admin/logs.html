<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Logs - App Training Exercises</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .table-container {
            margin-bottom: 2rem;
        }
        .log-time {
            min-width: 180px;
        }
        .session-actions {
            min-width: 100px;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">App Training Exercises</a>
            <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
                <a class="nav-link px-3" href="/admin/images.html">Images</a>
                <a class="nav-link px-3" href="/admin/users.html">Users</a>
                <a class="nav-link active px-3" href="/admin/logs.html">Logs</a>
                <button onclick="logout()" class="btn btn-outline-light">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Active Sessions Section -->
        <div class="table-container">
            <h2>Active Sessions</h2>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>IP Address</th>
                            <th>User Agent</th>
                            <th>Started</th>
                            <th>Last Activity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sessions-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Running Containers Section -->
        <div class="table-container">
            <h2>Running Containers</h2>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Exercise</th>
                            <th>User</th>
                            <th>Started</th>
                            <th>Time Remaining</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="containers-table"></tbody>
                </table>
            </div>
        </div>

        <!-- System Logs Section -->
        <div class="table-container">
            <h2>System Logs</h2>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th class="log-time">Time</th>
                            <th>Event</th>
                            <th>User</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Check admin authentication
        checkAdminAuth();

        async function checkAdminAuth() {
            try {
                const response = await fetch('/api/auth/check');
                const data = await response.json();
                
                if (!data.authenticated || !data.user.isAdmin) {
                    window.location.href = '/';
                    return;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/';
            }
        }

        // Fetch and display data
        async function fetchData() {
            try {
                // Fetch sessions
                const sessionsResponse = await fetch('/api/admin/sessions');
                const sessionsData = await sessionsResponse.json();
                displaySessions(sessionsData.sessions);

                // Fetch containers
                const containersResponse = await fetch('/api/admin/containers');
                const containersData = await containersResponse.json();
                displayContainers(containersData.containers);

                // Fetch logs
                const logsResponse = await fetch('/api/admin/logs');
                const logsData = await logsResponse.json();
                displayLogs(logsData.logs);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function displaySessions(sessions) {
            const tbody = document.getElementById('sessions-table');
            tbody.innerHTML = '';

            sessions.forEach(session => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${session.user_email} ${session.user_role === 'admin' ? '(Admin)' : ''}</td>
                    <td>${session.ip_address}</td>
                    <td>${session.user_agent}</td>
                    <td>${new Date(session.created_at).toLocaleString()}</td>
                    <td>${new Date(session.last_activity).toLocaleString()}</td>
                    <td class="session-actions">
                        <button onclick="terminateSession('${session.session_id}')" 
                                class="btn btn-sm btn-danger"
                                ${session.user_role === 'admin' ? 'disabled' : ''}>
                            Terminate
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function displayContainers(containers) {
            const tbody = document.getElementById('containers-table');
            tbody.innerHTML = '';

            containers.forEach(container => {
                const tr = document.createElement('tr');
                const createdAt = new Date(container.created_at).getTime();
                const now = Date.now();
                const elapsed = now - createdAt;
                const remaining = Math.max(0, 7200000 - elapsed); // 2 hours in milliseconds
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);

                tr.innerHTML = `
                    <td>${container.exercise_name} (Level ${container.level})</td>
                    <td>${container.user_email}</td>
                    <td>${new Date(container.created_at).toLocaleString()}</td>
                    <td>${minutes}m ${seconds}s</td>
                    <td>
                        <button onclick="stopContainer('${container.container_id}')" 
                                class="btn btn-sm btn-danger">
                            Stop
                        </button>
                        <a href="https://${container.subdomain}.apptraining.dbg.local" 
                           target="_blank" 
                           class="btn btn-sm btn-primary">
                            View
                        </a>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function displayLogs(logs) {
            const tbody = document.getElementById('logs-table');
            tbody.innerHTML = '';

            logs.forEach(log => {
                const tr = document.createElement('tr');
                const details = JSON.parse(log.details || '{}');
                
                tr.innerHTML = `
                    <td class="log-time">${new Date(log.created_at).toLocaleString()}</td>
                    <td>${log.event_type}</td>
                    <td>${log.user_email || 'System'}</td>
                    <td><pre class="mb-0"><code>${JSON.stringify(details, null, 2)}</code></pre></td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function terminateSession(sessionId) {
            if (!confirm('Are you sure you want to terminate this session?')) {
                return;
            }

            try {
                await fetch(`/api/admin/sessions/${sessionId}/terminate`, {
                    method: 'POST'
                });
                fetchData();
            } catch (error) {
                console.error('Error terminating session:', error);
                alert('Failed to terminate session');
            }
        }

        async function stopContainer(containerId) {
            if (!confirm('Are you sure you want to stop this container?')) {
                return;
            }

            try {
                await fetch(`/api/admin/containers/${containerId}/stop`, {
                    method: 'POST'
                });
                fetchData();
            } catch (error) {
                console.error('Error stopping container:', error);
                alert('Failed to stop container');
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Initial data fetch
        fetchData();
        // Refresh data every 30 seconds
        setInterval(fetchData, 30000);
    </script>
</body>
</html> 